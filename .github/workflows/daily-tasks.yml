name: Daily Influencer Tasks

on:
  schedule:
    # Run every day at midnight Korea Time (15:00 UTC / 00:00 KST)
    - cron: "0 15 * * *"
  workflow_dispatch:
    # Allows manual trigger from the GitHub Actions tab
    inputs:
      task:
        description: 'Task to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - featurings
          - contents
          - profile
          - import

  repository_dispatch:
    # Allows triggering via API (e.g. from Supabase Edge Function)
    types: [trigger-task]

jobs:
  run-tasks:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      - name: Install dependencies
        run: npm install

      - name: Run Tasks
        env:
          SUPABASE_PROJECT_ID: ${{ secrets.SUPABASE_PROJECT_ID }}
          SUPABASE_SECRET_KEY: ${{ secrets.SUPABASE_SECRET_KEY }}
          APIFY_TOKEN: ${{ secrets.APIFY_TOKEN }}
          FEATURING_EMAIL: ${{ secrets.FEATURING_EMAIL }}
          FEATURING_PASSWORD: ${{ secrets.FEATURING_PASSWORD }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          # Use input from manual dispatch or payload from API dispatch
          TASK_TO_RUN: ${{ github.event.inputs.task || github.event.client_payload.task || 'all' }}
        run: npm start
